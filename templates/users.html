{% extends 'layout.html' %}

{% block title %}–¢–µ–ª–µ–≥—Ä–∞–º –ë–æ—Ç - –î–æ—Å—Ç–∞–≤–∫–∞ | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏{% endblock %}

{% block content %}
<h1 class="mb-4">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–æ—Ç–∞</h1>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h3>–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
        <button class="btn btn-primary btn-sm" id="refresh-users">
            <i class="fas fa-sync-alt me-1"></i> –û–±–Ω–æ–≤–∏—Ç—å
        </button>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th scope="col">ID</th>
                        <th scope="col">–ò–º—è</th>
                        <th scope="col">–î–æ—Å—Ç–∞–≤–æ–∫</th>
                        <th scope="col">–†—É–±–ª–µ–π</th>
                        <th scope="col">–û–ø—ã—Ç–∞</th>
                        <th scope="col">–ê–∫—Ç–∏–≤–Ω—ã–µ –±–∞—Ñ—Ñ—ã</th>
                        <th scope="col">–ü–æ—Å–ª–µ–¥–Ω—è—è –¥–æ—Å—Ç–∞–≤–∫–∞</th>
                    </tr>
                </thead>
                <tbody id="users-table">
                    <tr>
                        <td colspan="7" class="text-center">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Function to fetch and display users
    function fetchUsers() {
        fetch('/dashboard/api/users')
            .then(response => response.json())
            .then(data => {
                const usersTable = document.getElementById('users-table');
                
                if (data.error) {
                    usersTable.innerHTML = `<tr><td colspan="7" class="text-center text-danger">–û—à–∏–±–∫–∞: ${data.error}</td></tr>`;
                    return;
                }
                
                if (!data.users || data.users.length === 0) {
                    usersTable.innerHTML = '<tr><td colspan="7" class="text-center">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö</td></tr>';
                    return;
                }
                
                let tableContent = '';
                
                data.users.forEach(user => {
                    tableContent += `
                        <tr>
                            <td>${user.telegram_id}</td>
                            <td>${user.username}</td>
                            <td>${user.deliveries}</td>
                            <td>${user.money}</td>
                            <td>${user.experience}</td>
                            <td>${user.active_buffs_count}</td>
                            <td>${user.last_delivery_time}</td>
                        </tr>
                    `;
                });
                
                usersTable.innerHTML = tableContent;
            })
            .catch(error => {
                console.error('Error fetching users:', error);
                document.getElementById('users-table').innerHTML = 
                    '<tr><td colspan="7" class="text-center text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</td></tr>';
            });
    }
    
    // Initial fetch
    fetchUsers();
    
    // Set up refresh button
    document.getElementById('refresh-users').addEventListener('click', fetchUsers);
    
    // Auto-refresh every 30 seconds
    setInterval(fetchUsers, 30000);
});
</script>
{% endblock %}
